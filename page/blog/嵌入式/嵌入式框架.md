# 机器人代码架构优化与模块设计规划


## 一、待办事项（todo）
1. 重构代码，支持在 `init`（初始化）阶段自定义方向，提升架构灵活性。
2. 基于新的模块划分规则，调整整车嵌入式代码架构。


## 二、核心设计思路（Idea）

### 1. 引入 Config 模式，实现参数化定制
- 核心目标：通过 `config`（配置）模式，在初始化阶段灵活修改参数，实现“一套代码适配多类机器人”。
- 关键设计：
  - 将 `config` 参数作为机器人核心特征（类似“句柄”）存储，统一管理硬件与功能参数。
  - 开放 `config` 作为用户接口，即使是非软件开发的机械工程师，也能通过修改 `config` 快速调整机器人参数。


### 2. Config 存储与硬件解耦设计
- Config 存储位置扩展：
  - 本地存储：将 `config` 存入单片机 `Flash`，满足离线使用场景。
  - 近端管理：将 `config` 部署在上位机（小电脑），支持上位机直接修改和保存配置。
  - 远程管理：将 `config` 托管至云端，由上位机主动拉取配置文件；远期可实现远程烧录固件。
- 硬件解耦方案（以 STM32 为例）：
  - 底层硬件接口（如 CAN 总线、USART、USB）通过“句柄（handle）”抽象为“设备树（device tree）”，并固化在初始烧录程序中。
  - 将设备操作地址通过 `handle` 传递给上层固件，实现“主板与外设的分离”（例如：CAN 总线上的电机、USART 连接的裁判系统、USB 挂载的上位机）。
  - 电机 CAN ID 等外设参数可纳入 `config` 管理，进一步提升硬件适配性。


### 3. 模块化程序设计
- 模块定义：所有功能程序均以“模块”为单位封装，相同功能的模块归为同一层级。
- 模块规范：
  - 接口要求：统一模块接口标准，接口需包含版本号；大型模块需单独编写说明文档，小型模块可在 `.h` 头文件中注明接口信息。
  - 依赖管理：明确模块间的依赖关系，避免循环依赖。


## 三、模块核心组成与数据流向
### 1. 模块组成部分
| 类别   | 具体内容                  | 说明                          |
|--------|---------------------------|-------------------------------|
| 数据   | 句柄（handle）            | 模块标识、资源访问入口       |
|        | 配置（config）            | 模块初始化与运行的参数    |
| 程序   | 初始化（init）            | 参数加载、资源初始化 |
|        | 启动（start）             | 触发、开始运行             |
|        | 功能（function）          | 核心业务逻辑          |
|        | 结束（finish）            | 停止运行、资源释放      |

### 2. 数据流向规则
- `config` → 输入 `init` → 输出 `handle`（初始化后生成模块唯一句柄）；
- `handle` → 输入 `function` → 输出结果（如硬件控制信号、电机指令、数据计算结果）；
- `handle` → 输入 `start`/`finish` → 无输出（触发模块启动 / 停止）。


## 四、分层设计与耦合管理
1. **分层原则**：层级数量宜少，配合包管理机制，简化架构复杂度。
2. **耦合规则**：
   - 单向耦合：高层模块依赖低层模块，禁止低层模块反向依赖高层模块。
   - 解耦方式：通过“注册数据/函数”的设计模式，避免直接依赖（如上层模块向底层注册回调函数，而非直接调用底层接口）。
3. **耦合登记**：由架构管理模块统一“登记（register）”模块间的耦合关系，参考 Linux 内核的设备树机制，实现依赖可视化。


## 五、模块热插拔支持
设计架构需预留模块热插拔能力，允许在系统运行过程中动态加载/卸载模块（如替换不同功能的电机控制模块、传感器模块），无需重启整个系统。


## 六、模块版本管理
为确保模块兼容性与可维护性，需建立模块版本管理机制：
- 每个模块需标注 **版本号**；
- 明确模块的 **依赖关系**（如依赖的底层模块及版本）；
- 标注模块 **接口版本**，确保接口变更时不影响依赖模块的正常运行。

## 七、日志管理

模块由



$$ J_{LQR} := \int_{0}^{\infty} \left( \sum_{i=1}^{\ell} Q_{ii} z_i(t)^2 + \rho \sum_{j=1}^{m} R_{jj} u(t)^2 \right) dt. $$

$Q$ 和 $P$ 是一个对角矩阵，